<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>Royal Point</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

  <!-- Sanwithz Style -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sanwithz/Form/sanwithzstyle2.min.css">

  <!-- Sweet Alert -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Loading Overlay -->
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- html5 qrcode -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    .bg-silver {
      background: linear-gradient(135deg, #C0C0C0, #ffffff);
      color: #333;
    }

    .bg-gold {
      background: linear-gradient(135deg, #FFD700, #FFF3B0);
      color: #333;
    }

    .bg-diamond {
      background: linear-gradient(30deg, #3f87a6, #ebf8e1, #f69d3c);
      color: #333;
    }

    #displaySection {
      display: none;
    }

    .h1,
    .h2,
    .h3,
    .h4,
    .h5,
    .h6,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin-top: 0;
      margin-bottom: 0;
    }

    .modal-fullscreen {
      width: 100%;
      max-width: none;
      height: 100%;
      margin: 0;
    }

    .modal-fullscreen .modal-content {
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 0;
    }

    .modal-fullscreen .modal-body {
      overflow-y: auto;
    }

    /* ขนาดหน้าจอมือถือ */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .btn-lg {
        width: 100%;
      }

      .card-img-top {
        width: 100%;
        height: auto;
      }

      h2 {
        font-size: 1.5rem;
      }

      .modal-fullscreen {
        height: 100%;
      }

      /* ปรับขนาดของโมดัลสำหรับมือถือ */
      .modal-dialog {
        max-width: 90%;
      }
    }

    /* ปรับขนาดสำหรับจอมือถือที่เล็กมาก */
    @media (max-width: 576px) {
      .modal-dialog {
        max-width: 90%;
      }
    }
  </style>

</head>

<body class="bg-light">

  <div class="container mt-2">
    <img src="https://lh3.googleusercontent.com/d/1ewOWxYLOyvTiRO9zwj1QbDcA0PWaIduY" class="card-img-top rounded-4" alt="Header">

    <div id="regSection">
      <div class="mt-5">
        <h2 class="text-center">ระบบลงทะเบียนใช้งาน</h2>
        <form id="dataForm" class="list mt-3">
          <div class="mb-3" style="display:none">
            <label for="uid" class="form-label disable">UID</label>
            <input type="text" class="form-control" id="uid" name="uid" readonly>
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">ชื่อ - นามสกุล</label>
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="sex" class="form-label">Section</label>
            <select class="form-control" id="room" name="room" required>
              <option value="" disabled selected>เลือก</option>
              <option value="CS">CS</option>
              <option value="OS">OS</option>
              <option value="MTN">MTN</option>
              <option value="PC">PC</option>
              <option value="PD1">PD1</option>
              <option value="PD2">PD2</option>
              <option value="PE">PE</option>
              <option value="QA">QA</option>
              <option value="QC">QC</option>
              <option value="WH">WH</option>
              <option value="SHE">SHE</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="dob" class="form-label">วันเกิด</label>
            <input type="date" class="form-control" id="dob" name="dob" required>
          </div>
          <div class="mb-3">
            <label for="passport" class="form-label">เลขประจำตัวพนักงาน/Passport</label>
            <input type="text" class="form-control" id="passport" name="passport" required>
          </div>
          <div class="mb-3">
            <label for="telephone" class="form-label">เบอร์โทรศัพท์</label>
            <input type="text" class="form-control" id="telephone" name="telephone" required>
          </div>
          <button type="submit" class="btn btn-primary btn-lg w-100">สมัครใช้งาน</button>
        </form>
      </div>
    </div>

    <div id="displaySection" class="list mt-2">
      <div class="d-flex align-items-center bg-silver p-3 rounded-4 shadow-sm mb-3">
        <img id="profilePic" src="https://placehold.co/60x60" class="rounded-circle border border-2 border-white shadow me-3" style="width: 60px; height: 60px;" />

        <div>
          <div class="fw-bold fs-6" id="username">KruBank Sitti</div>
          <div class="text-muted small">
            <span>ชั้น ม.6/99 เลขประจำตัวนักเรียน 99</span><br/>
            <span id="phone"><i class="fas fa-phone"></i> 0906616611</span>
          </div>
        </div>
        <div class="ms-auto text-end">
          <div class="text-warning fw-bold" style="margin-right: 10px;">
            <h2><i class="fas fa-coins"></i></h2>
            <h2 id="points">100</h2>
            <h5>Pt</h5>
          </div>
        </div>
      </div>

      <div class="text-center mt-2">
        <div>
          <svg viewBox="0 0 100 50" class="w-100">
            <path d="M 10 50 A 40 40 0 0 1 90 50" stroke="#eee" stroke-width="10" fill="none" />
            <path id="progressCurve" d="M 10 50 A 40 40 0 0 1 90 50" stroke="#30674c" stroke-width="10" fill="none"
              stroke-dasharray="126" stroke-dashoffset="42" stroke-linecap="round" />
          </svg>
          <div class="text-center mt-2 mb-4 fw-bold">ระดับ Silver</div>
        </div>

        <p>สะสมอีก <strong>50</strong> พ้อยท์ ภายใน <strong>31/12/65</strong><br>เพื่อเลื่อนสถานะเป็น <strong>Gold</strong> ในปี 2568</p>

        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#scoreModal">
          <i class="fa-solid fa-qrcode"></i> สแกนคิวอาร์โค้ดรับพ้อยท์
        </button>

        <button class="btn btn-primary btn-sm me-2" onclick="refreshUserScore()">
          <i class="fa-solid fa-arrows-rotate"></i>
        </button>

      </div>
    </div>

    <div id="Ads" class="card-img-top rounded-4 mt-3">
      <div id="carouselAdsControls" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner rounded-4 overflow-hidden">
          <div class="carousel-item active">
            <img src="https://lh3.googleusercontent.com/d/1j6_CKghy0tLKW2dJW7W1E8TLMKxMtJTl" class="d-block w-100" alt="Ad 1">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/1SJkRqfgv8r5D_r0_z-GXCI464oLxhgkc" class="d-block w-100" alt="Ad 2">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/16N6b_e-IcwKSX2HTGqj16mVBClGOpsHy" class="d-block w-100" alt="Ad 3">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/1OGXDAXetVntB-41IV0_Use-9pfTsWW2V" class="d-block w-100" alt="Ad 4">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/13Ttsi9DvLSGsH-AjQy1CcP_eI_KEkL1o" class="d-block w-100" alt="Ad 5">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/1Z6RYx1KgOxntePOrzMj2Dm_-bdgWarjS" class="d-block w-100" alt="Ad 6">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/1m7bRy0mp7_YE-O5JqNUMVWUVMqprtkgw" class="d-block w-100" alt="Ad 7">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/1qmygrMXw5y-fGkOgMFq6gXamQalbVa9K" class="d-block w-100" alt="Ad 8">
          </div>
          <div class="carousel-item">
            <img src="https://lh3.googleusercontent.com/d/10yaUxnCT3eIJYiRj7AMv1GPL5_m9LrX9" class="d-block w-100" alt="Ad 9">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselAdsControls" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">ก่อนหน้า</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselAdsControls" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">ถัดไป</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Add Score -->
  <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h4 class="modal-title" id="scoreModalLabel"><i class="fa-solid fa-qrcode"></i> เพิ่มคะแนนสะสม</h4>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ปิด"></button>
        </div>
        <div class="modal-body text-center">
          <div id="qr-reader" style="width: 100%; max-width: 400px; margin: auto;"></div>

          <hr class="my-4">

          <div class="form-group">
            <label for="secretCode" class="form-label">หรือกรอกรหัสลับเพื่อรับคะแนน</label>
            <input type="text" id="secretCode" class="form-control text-center" placeholder="กรอกรหัสลับ">
            <button onclick="submitSecretCode()" class="btn btn-success mt-3"><i class="fa-solid fa-check"></i> ยืนยันรับคะแนน</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const serverUrl = "https://script.google.com/macros/s/AKfycbw-OjEA1jOjlER_ZWro3Fnvvi4AjZAIzIYc1Fq8lwQ-07wsvZnO8VPt9R0UYtUL3GyhuQ/exec";
    const liffID = "2007053300-QoEvbXyn";
    const jsonUrl = "https://opensheet.elk.sh/1uT_aeo5WzqV1Wc2I_ju09k9APYgqYexpiFPMBVCJx9M/Score";

    $(document).ready(function () {

      $('#regSection').hide();

      liff.init({ liffId: liffID }).then(() => {
        if (liff.isLoggedIn()) {

          $.LoadingOverlay("show", {
            image: "",
            fontawesome: "fa fa-spinner fa-spin",
            text: "กำลังโหลดข้อมูล..."
          });
      
      liff.getProfile().then(profile => {
        const uid = profile.userId;
        $('#uid').val(uid);
        $('#profilePic').attr('src', profile.pictureUrl);

        fetch(jsonUrl)
          .then(res => res.json())
          .then(data => {
            const userData = data.find(d => d.Uid === uid);
            if (userData) {
              $('#displaySection').show();
              $('#username').text(userData.Name);
              $('#phone').html(`<i class="fas fa-phone"></i> ${userData.Tel}`);
              $('.text-muted span:first').text(`ส่วนงาน : ${userData.Classroom} |${userData.Passport}`);
              $('#profilePic').attr('src', profile.pictureUrl);

              let score = parseInt(userData.Score || "0");
              $('#points').text(score);

              const percent = score / 100;
              const totalLength = 100;
              const offset = totalLength * (1 - percent);
              document.getElementById("progressCurve").style.strokeDashoffset = offset;

              let tierText = "ระดับ Silver";
              let bgClass = "bg-silver";
              let nextTierScore = 100;

              if (score >= 350) {
                tierText = "ระดับ Diamond";
                bgClass = "bg-diamond";
                nextTierScore = 800;
              } else if (score >= 100) {
                tierText = "ระดับ Gold";
                bgClass = "bg-gold";
                nextTierScore = 350;
              }

              $('.d-flex').removeClass("bg-silver bg-gold bg-diamond").addClass(bgClass);
              $('.text-center.mt-2.mb-4.fw-bold').text(tierText);

              let remaining = nextTierScore - score;
              if (remaining > 0) {
                $('p:contains("สะสมอีก")').html(`สะสมอีก <strong>${remaining}</strong> พ้อยท์ ภายใน <strong>31/12/68</strong><br>เพื่อเลื่อนสถานะเป็น <strong>${tierText === "ระดับ Gold" ? "Diamond" : "Supreme"}</strong> ในปี 2568`);
              } else {
                $('p:contains("สะสมอีก")').html(`คุณอยู่ในระดับสูงสุดแล้ว 🎉`);
              }

            } else {
              $('#regSection').show();
              $('#displaySection').hide();
            }
            $.LoadingOverlay("hide");
          })
          .catch(error => {
            console.error("Fetch error:", error);
            $.LoadingOverlay("hide");
            Swal.fire("ผิดพลาด", "โหลดข้อมูลไม่สำเร็จ", "error");
          });
      });
    } else {
      liff.login();
    }
  }).catch(err => console.error(err));

  $('#dataForm').ajaxForm({
    url: serverUrl,
    type: 'POST',
    dataType: 'json',
    beforeSubmit: function () {
      Swal.fire({
        title: 'กำลังบันทึก...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });
    },
    success: function (response) {
      if (response.status === 'success') {
        Swal.fire({
          icon: 'success',
          title: 'ลงทะเบียนสำเร็จ!',
          text: 'ข้อมูลของคุณถูกบันทึกแล้ว'
        });

        $('#username').text($('#name').val());
        $('#phone').html('<i class="fas fa-phone"></i> ' + $('#telephone').val());
        const room = $('#room').val();
        const passport = $('#passport').val();
        $('.text-muted span:first').text(`ชั้น ${room} เลขที่ ${passport}`);
        $('#points').text('0');

        $('#regSection').hide();
        $('#displaySection').show();

        document.getElementById("progressCurve").style.strokeDashoffset = 126; // 0%
      } else {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด!',
          text: 'ไม่สามารถส่งข้อมูลได้'
        });
      }
    },
    error: function () {
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด!',
        text: 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้'
      });
    }
  });
});

function submitData() {
$.LoadingOverlay("show", {
image: "",
fontawesome: "fa fa-spinner fa-spin",
text: "กำลังบันทึกข้อมูล..."
})

  const data = {
    name: $('#username').text(),
    phone: $('#phone').text().replace("📞", "").trim(),
    points: $('#points').text(),
    tier: "Silver"
  };

  fetch(serverUrl, {
    method: "POST",
    body: new URLSearchParams(data)
  })
    .then(res => res.json())
    .then(result => {
      $.LoadingOverlay("hide");
      Swal.fire("ส่งข้อมูลแล้ว", "ระบบบันทึกพ้อยท์เรียบร้อย", "success");
    })
    .catch(error => {
      $.LoadingOverlay("hide");
      Swal.fire("ผิดพลาด", "ไม่สามารถส่งข้อมูลได้", "error");
    });
}


  
function submitSecretCode() {
  const code = $('#secretCode').val().trim();
  if (!code) {
    Swal.fire("กรุณากรอกรหัสลับ");
    return;
  }

  $.LoadingOverlay("show");
  fetch(serverUrl, {
    method: "POST",
    body: new URLSearchParams({
      uid: $('#uid').val(),
      code: code,
      type: 'manual'
    })
  }).then(res => res.json()).then(data => {
    $.LoadingOverlay("hide");
    if (data.status === "success") {
      Swal.fire("สำเร็จ", "คุณได้รับคะแนนแล้ว", "success");
      $('#scoreModal').modal('hide');
      refreshUserScore();
    } else if (data.status === "used") {
      Swal.fire("รหัสถูกใช้แล้ว", "รหัสนี้ถูกใช้ไปแล้ว กรุณาลองใหม่", "warning");
    } else {
      Swal.fire("รหัสไม่ถูกต้อง", "กรุณาตรวจสอบรหัสที่กรอกอักครั้ง", "error");
    }
  }).catch(err => {
    $.LoadingOverlay("hide");
    Swal.fire("ผิดพลาด", "เกิดข้อผิดพลาดในการส่งข้อมูล", "error");
  });
}


function onScanSuccess(decodedText, decodedResult) {
  $('#scoreModal').modal('hide');
  $.LoadingOverlay("show");

  fetch(serverUrl, {
    method: "POST",
    body: new URLSearchParams({
      uid: $('#uid').val(),
      code: decodedText,
      type: 'scan'
    })
  })
  .then(res => res.json())
  .then(data => {
    $.LoadingOverlay("hide");

    if (data.status === "success") {
      Swal.fire("สำเร็จ", `คุณได้รับคะแนนจาก QR แล้ว (+${data.point})`, "success");
      refreshUserScore();
    } else if (data.status === "invalid") {
      Swal.fire("ไม่สามารถใช้ QR นี้ได้", data.message || "QR นี้ไม่ถูกต้องหรือถูกใช้ไปแล้ว", "error");
    } else {
      Swal.fire("เกิดข้อผิดพลาด", "โปรดลองใหม่ภายหลัง", "error");
    }
  })
  .catch(err => {
    $.LoadingOverlay("hide");
    Swal.fire("ผิดพลาด", "เกิดข้อผิดพลาดในการสแกน", "error");
  });
}


let html5QrcodeScanner;
$('#scoreModal').on('shown.bs.modal', function () {
  if (!html5QrcodeScanner) {
    html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", {
      fps: 10,
      qrbox: 250
    });
  }
  html5QrcodeScanner.render(onScanSuccess);
});
  
//   $('#scoreModal').on('shown.bs.modal', function () {
//   const html5QrCode = new Html5Qrcode("qr-reader");
//   Html5Qrcode.getCameras().then(cameras => {
//     const backCamera = cameras.find(camera => camera.label.toLowerCase().includes("back")) || cameras[0];
//     if (backCamera) {
//       html5QrCode.start(
//         { deviceId: { exact: backCamera.id } },
//         {
//           fps: 10,
//           qrbox: 250
//         },
//         onScanSuccess
//       ).catch(err => {
//         console.error("Camera start error:", err);
//         Swal.fire("ผิดพลาด", "ไม่สามารถเข้าถึงกล้องได้", "error");
//       });
//     }
//   }).catch(err => {
//     console.error("Camera fetch error:", err);
//     Swal.fire("ผิดพลาด", "ไม่พบกล้อง", "error");
//   });

//   html5QrcodeScanner = html5QrCode;
// });

// $('#scoreModal').on('hidden.bs.modal', function () {
//   if (html5QrcodeScanner) {
//     html5QrcodeScanner.stop().then(() => {
//       html5QrcodeScanner.clear();
//     }).catch(err => {
//       console.warn("Stop camera error", err);
//     });
//   }
// });


$('#scoreModal').on('hidden.bs.modal', function () {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.clear();
  }
});
  
  
  
  function refreshUserScore() {
  fetch(jsonUrl)
    .then(res => res.json())
    .then(data => {
      const uid = $('#uid').val();
      const userData = data.find(d => d.Uid === uid);
      if (userData) {
        let score = parseInt(userData.Score || "0");
        $('#points').text(score);

        const percent = score / 100;
        const totalLength = 100;
        const offset = totalLength * (1 - percent);
        document.getElementById("progressCurve").style.strokeDashoffset = offset;

        let tierText = "ระดับ Silver";
        let bgClass = "bg-silver";
        let nextTierScore = 100;

        if (score >= 350) {
          tierText = "ระดับ Diamond";
          bgClass = "bg-diamond";
          nextTierScore = 800;
        } else if (score >= 100) {
          tierText = "ระดับ Gold";
          bgClass = "bg-gold";
          nextTierScore = 350;
        }

        $('.d-flex').removeClass("bg-silver bg-gold bg-diamond").addClass(bgClass);
        $('.text-center.mt-2.mb-4.fw-bold').text(tierText);

        let remaining = nextTierScore - score;
        if (remaining > 0) {
          $('p:contains("สะสมอีก")').html(`สะสมอีก <strong>${remaining}</strong> พ้อยท์ ภายใน <strong>31/12/68</strong><br>เพื่อเลื่อนสถานะเป็น <strong>${tierText === "ระดับ Gold" ? "Diamond" : "Supreme"}</strong> ในปี 2568`);
        } else {
          $('p:contains("สะสมอีก")').html(`คุณอยู่ในระดับสูงสุดแล้ว 🎉`);
        }
      }
    });
}

  </script>



  <footer style="font-size: 14px;">
    © <script>
      document.write(new Date().getFullYear());
    </script> Copyright | พัฒนาโดยสัตยา วงศ์ชมภู Safety Officer
  </footer>

</body>

</html> -->